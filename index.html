<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
	<link rel="stylesheet" href="css/rs_idan.css" type="text/css" media="screen, projection">
	<link rel="stylesheet" href="css/rs.css" type="text/css" media="screen, projection">
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui/jquery-ui.min.js"></script>
	<style type="text/css"></style>
	<script type="text/javascript" src="js/jquery.switcher.js"></script>
	<script type="text/javascript" src="js/rs.js"></script>
	<style type='text/css'>
		.right_border { border-right: 5px solid #A65200; }
		.bottom_border { border-bottom: 5px solid #A65200; }
	</style>

	<script>
		function setUserName() {
			var userName = prompt("Please enter a non-empty username:", "");
			setCookie("userName", userName, 100);
			return userName;
		}
		
		function getCookie(cname) {
			var name = cname + "=";
			var ca = document.cookie.split(';');
			for(var i=0; i<ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0)==' ') c = c.substring(1);
				if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
			}
			return "";
		}
		
		function setCookie(cname, cvalue, exdays) {
			var d = new Date();
			d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
			var expires = "expires=" + d.toUTCString();
			document.cookie = cname + "=" + cvalue + "; " + expires;
		}
	</script>

	<script> 
		var len = 8;
		var data = 0;
		var marked = 0;
		var logFile = 0;
		var circles = {};
		var selected = {"#img1":false, "#img2":false, "#img3":false,
						"#img4":false, "#img5":false, "#img6":false,
						"#img7":false, "#img8":false, "#img9":false, "#img10":false};
		var logger = []
		
		function updater() { 
			var redmatched = [];
			var bluematched = [];
			var unmatched = [];
			if (data == 0) {		
				var userName = getCookie("userName");
				userName = "Idan"
				while (userName == "" || userName == null) {
					userName = setUserName();
				}
				$('#userName').text("Logged in as: " + userName);
				$.ajax({
					async: false,
					type: "GET",
					url: "newUser",
					data: {user: userName},
					success: function(data) {
						logFile = data;
					}					
				});
			} else {
				marked = 0;
				$('#blueImg').attr('class', "blueshadow");
				$('#redImg').attr('class', "redshadow");
				for (var k in selected) {
					if (selected[k]) {
						if ($(k).attr('class') == "redclicked") {
							redmatched.push("\"" + $(k).attr('src') + "\"");
						} else {
							bluematched.push("\"" + $(k).attr('src') + "\"");
						}
						update(k);
					} else {
						unmatched.push("\"" + $(k).attr('src') + "\"");
					}
				}
				var comment = $("#comment").attr('value')
				var send = {log: logFile, red: "\"" + $("#redImg").attr('src') + "\"", blue: "\"" + $("#blueImg").attr('src') + "\"", 
							mreds: redmatched, mblues: bluematched, no: unmatched, logging: logger, comm: comment};
				$("#comment").attr('value', "")
				
				$.ajax({
					async: true,
					type: "POST",
					url: "data",
					data : send
				});
				//$.floatingMessage("Display message with timer.", {time:3000});
			}
			
			$.ajax({
				async: false,
				type: 'GET',
				data: {num: len},
				url: 'newImage',
				success: function(info) {
				  if (data == 0) {
						data = info;
						updater();
					} else {
						preload(info);
						$("#redImg").attr('src', data[0]);
						$("#redImgHist").attr('src', data[1]);
						$("#blueImg").attr('src', data[2]);
						$("#blueImgHist").attr('src', data[3]);
						for (var i = 4; i < len + 2; i++) {
							$("#img" + (i - 3)).attr('src', data[i]);
						}
						data = info;
					}
				}
			});
				
			circles = {};
			redrawAll();
		};
		
		function cleanSession() {
			setCookie("userName", "", 0);
			data = 0;
			updater();
		}
		
		function preload(arrayOfImages) {
			$(arrayOfImages).each(function () {
				$('<img />').attr('src',this).appendTo('body').css('display','none');
			});
		}
		
		function update(tag) {
			if (selected[tag] == undefined) {
				if (tag == '#redImg') {
					theSrc = $('#redImg').attr('src');
					addCircle(theSrc, "red")
					delCircle($('#blueImg').attr('src'));
					logger.push(theSrc + " reference selected (red)");
					$('#redImg').attr('class', "redclicked");
					$('#blueImg').attr('class', "blueshadow");

					marked = 1;
				} else {
					theSrc = $('#blueImg').attr('src');
					addCircle(theSrc, "blue")
					delCircle($('#redImg').attr('src'));
					logger.push(theSrc + " reference selected (blue)");
					$('#redImg').attr('class', "redshadow");
					$('#blueImg').attr('class', "blueclicked");
					marked = 2;
				}
			} else {
				if (selected[tag]) {
					theSrc = $(tag).attr('src');
					delCircle(theSrc);
					logger.push(theSrc + " was deselected")
					$(tag).attr('class', "imagedropshadow");
				} else {
					theSrc = $(tag).attr('src');
					if (marked == 0) {
						return;
					} else if (marked == 1) {
						addCircle(theSrc, "red")
						logger.push(theSrc + " was selected as red")
						$(tag).attr('class', "redclicked");
					} else {
						addCircle(theSrc, "blue")
						logger.push(theSrc + " was selected as blue")
						$(tag).attr('class', "blueclicked");
					}
				}
				selected[tag] = !selected[tag];
			}
		}
		
		window.onresize = myCanvas;
		var fullImage;
		var width = 0;
		var height = 0;
		var canvas;
		var ctx;
		
		function parseDims(str) {
			splitted = str.split(/\.|_/);
			return splitted.splice(splitted.length - 4, 3);
		}
		
		function myCanvas() {
			fullImage = document.getElementById("mainImg");	
			canvas = document.getElementById("myCanvas");
			
			var cords = parseDims(fullImage.src);
			width = cords[0];
			height = cords[1];
			canvas.width = canvas.parentNode.offsetWidth;
			canvas.height = canvas.parentNode.offsetWidth * height / width;
			ctx = canvas.getContext("2d");
			ctx.imageSmoothingEnabled = true;
			ctx.mozImageSmoothingEnabled = true;
			redrawAll();
		}
		
		function delCircle(img) {
			delete circles[img];
			redrawAll();
		}
		
		function addCircle(img, color) {
			dims = parseDims(img);
			x = dims[0]; y = dims[1]; r = dims[2];
			var ratio = canvas.width / width;
			var centerX = x * ratio
			var centerY = y * ratio
			var radius = r * ratio;
			var toAdd = [centerX, centerY, radius, color];
			circles[img] = toAdd;
			redrawAll();
		}
		
		function redrawAll() {
			ctx.drawImage(fullImage, 0, 0, canvas.width, canvas.height);
			Object.keys(circles).forEach(function (key) {
				circle = circles[key];
				ctx.beginPath();
				ctx.arc(circle[0], circle[1], circle[2], 0, 2 * Math.PI, false);
				ctx.lineWidth = 3;
				ctx.strokeStyle = circle[3];
				ctx.stroke();
			});
		}
</script>
</head>

<body onLoad="myCanvas(); updater()">
	<img id="mainImg" src="http://idanizhaki.me:8080/img/stem_5311_2612_0.jpg" style="display:none">
	<header id="top">

		<div class="ryan">
			<p align="center" id="userName" style="color:white">Please login</p>
			<p align="center" style="color:grey; cursor:pointer" onclick="cleanSession()">[Logout]</p>
		</div>

	</header>
	<div id="container" align="center" style="width:90%;height:100%;border:5px solid #000;border-bottom-left-radius: 35px;border-color: #A65200;
						border-radius: 35px;background-image: url('img/bg.jpg');">
		<section>
		<table class="tftable" border="0" style="width:100%">
		<tr>
			<th width="70%" height="100%" class="right_border">
				<canvas id="myCanvas" width="1150%" height="500%" style="border:3px solid #A65200; width='100%'; border-radius: 15px;"> Your browser does not support the HTML5 canvas tag.</canvas>
			</th>
			<th width="30%">
				<table class="tftable" border="0" style="width:110%" align="left">
				<tr>
					<th class="bottom_border"><a><img onclick="update('#redImg')" id="redImg" class="redshadow" src="" width=50% style="border-radius: 50%"/></a>
						<a><img onclick="" id="redImgHist" class="redshadow" src="" width=20%/></a></th>
					<th><a><img onclick="update('#blueImg')" id="blueImg" class="blueshadow" src="" width=50% style="border-radius: 50%"/></a>
						<a><img onclick="" id="blueImgHist" class="blueshadow" src="" width=20%/></a></th>
				</tr>
				<tr>
					<th><a><img onclick="update('#img1')" id="img1" class="imagedropshadow" src="" width=50% style="border-radius: 50%"/></a></th>
					<th><a><img onclick="update('#img2')" id="img2" class="imagedropshadow" src="" width=50% style="border-radius: 50%"/></a></th>
				</tr>
				<tr>
					<th><a><img onclick="update('#img3')" id="img3" class="imagedropshadow" src="" width=50% style="border-radius: 50%"/></a></th>
					<th><a><img onclick="update('#img4')" id="img4" class="imagedropshadow" src="" width=50% style="border-radius: 50%"/></a></th>
				</tr>
				<tr>
					<th><a><img onclick="update('#img5')" id="img5" class="imagedropshadow" src="" width=50% style="border-radius: 50%"/></a></th>
					<th><a><img onclick="update('#img6')" id="img6" class="imagedropshadow" src="" width=50% style="border-radius: 50%"/></a></th>
				</tr>
				</table>
			</th>
		</tr>
		</table>
		<input type="image" src="https://rusticcitrus.com/app/resources/images/buttons/gameBoard/submitButton.png" alt="Submit" style="height:10%;width:10%" onclick="updater()"/>
		<h3 style="color:#FFFFEB">Please enter description for selection:</h3>
		<textarea id="comment" name="myTextBox" style="width:70%;height:100px;border:5px solid #000;border-bottom-left-radius: 35px;border-color: #A65200;
						border-radius: 35px;font-size: 1.5em; padding:20px; line-height: 120%; background: #FFFFEB" with="50%"></textarea>
		</section>
		<h2 style="color: #FFFFEB">Segments Matching<span>Idan Izhaki @ UCSD</span></h2>

		<div class="social">
			<a class="twitter" href="http://twitter.com/idan192" style="background-image: url(../images/twitter.png)" data-username="idan192">...........</a>
			<a class="linkedin" href="http://linkedin.com/in/idan192" style="background-image: url(../images/linkedin.png)" data-username="229841078">...........</a>
			<a class="github" href="http://github.com/idan192" style="background-image: url(../images/github.png)">...........</a>
			<a class="email" href="mailto:iizhaki@eng.ucsd.edu" style="background-image: url(../images/email.png)">...........</a>
		</div>
	</div>
</body>

</html>







